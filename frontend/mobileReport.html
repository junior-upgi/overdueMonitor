<!doctype html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="utf-8" http-equiv="pragma" content="no-cache" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
    <title>逾期款日報</title>
    <style>
        @import url(http://fonts.googleapis.com/earlyaccess/notosanstc.css);
        * {
            font-family: 'Noto Sans TC', Consolas;
        }
        
        tr th {
            text-align: center;
        }
        
        td,
        th {
            padding: 5px;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 120%;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div style="text-align:center;">
        <h1 style="margin:auto;clear:both;">逾期款即時資訊</h1>
        <h2 id="currentDate" style="margin:auto;clear:both;"></h2>
        <table border="1" style="width:auto;margin:auto;clear:both;">
            <thead>
                <caption>
                    <h2>【整體款項統計】</h2>
                </caption>
                <tr>
                    <th style="text-align:center;">未逾期應收款總額</th>
                    <th style="text-align:center;">逾期款總額</th>
                    <th style="text-align:center;">預收款總額</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="AMTN_PENDING_SUMMARY" style="text-align:center;"></td>
                    <td id="AMTN_OVERDUE_SUMMARY" style="text-align:center;"></td>
                    <td id="AMTN_DEPOSIT_SUMMARY" style="text-align:center;"></td>
                </tr>
            </tbody>
        </table>
        <table border="1" style="width:auto;margin:auto;clear:both;">
            <thead>
                <caption>
                    <h2>【年度款項統計】</h2>
                </caption>
                <tr>
                    <th style="text-align:center;">年度</th>
                    <th style="text-align:center;">未逾期應收款總額</th>
                    <th style="text-align:center;">逾期款總額</th>
                </tr>
            </thead>
            <tbody id="annualReportSummary"></tbody>
        </table>
    </div>
    <div>
        <div>
            <h2>【昨日新增逾期款項】</h2>
            <ol id="newOverdueList">
            </ol>
        </div>
        <div>
            <h2>【當週逾期款項提醒】</h2>
            <ol id="weeklyOverdueSummary">
            </ol>
        </div>
    </div>
</body>

</html>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js" charset="utf-8"></script>
<script>
    $(document).ready(function() {
        var currentDate = new Date();
        $("#currentDate").text(currentDate.getFullYear() + '/' + (currentDate.getMonth() + 1) + '/' + currentDate.getDate());
        $.getJSON("dataSource/overview.php", function(result) {
            $("#AMTN_PENDING_SUMMARY").text(numeral(result[0].AMTN_PENDING).format("$0,0"));
            $("#AMTN_OVERDUE_SUMMARY").text(numeral(result[0].AMTN_OVERDUE).format("$0,0"));
            $("#AMTN_DEPOSIT_SUMMARY").text(numeral(result[0].AMTN_DEPOSIT).format("$0,0"));
        });
        $.getJSON("dataSource/annualReportSummary.php", function(result) {
            $.each(result, function(recordIndex, record) {
                $("#annualReportSummary").append("<tr><td style=\"text-align:center;\">" + record.YEAR + "</td><td style=\"text-align:center;\">" + numeral(record.AMTN_PENDING).format("$0,0") + "</td><td style=\"text-align:center;\">" + numeral(record.AMTN_OVERDUE).format("$0,0") + "</td></tr>");
            });
        });
        $.getJSON("dataSource/overdueAlert.php", function(result) {
            $.each(result, function(recordIndex, record) {
                $("#newOverdueList").append("<li class=\"overdueItem newOverdue\" data-client=\"" + record.CUS_NO + "\">" + record.content + "</li>");
            });
            $(".newOverdue").css("color", "red");
            $.getJSON("dataSource/weeklyAlert.php", function(result) {
                $.each(result, function(recordIndex, record) {
                    if (record.G_PERIOD_REMAIN == 0) {
                        $("#weeklyOverdueSummary").append("<li class=\"overdueItem weekOldOverdue\" data-client=\"" + record.CUS_NO + "\">" + record.content + "</li>");
                    } else {
                        $("#weeklyOverdueSummary").append("<li class=\"overdueItem\" data-client=\"" + record.CUS_NO + "\">" + record.content + "</li>");
                    }
                });
                $("li").css("font-size", "100%");
                $(".weekOldOverdue").css("color", "red");
                $(".overdueItem").click(function() {
                    if ($(this).hasClass("selected") == false) {
                        $(".selected").removeClass("selected");
                        $(this).addClass("selected");
                        console.log($(this).data("client"));
                        $.getJSON("dataSource/transactionDetail.php?CUS_NO=" + $(this).data("client"), function(result) {
                            $("#dynamicTable").remove();
                            $(".selected").append("<table id=\"dynamicTable\" border=\"1\"></table>");
                            $("#dynamicTable").append("<tr class=\"heading\"><th>銷貨編號</th><th>出貨日期</th><th>金額</th><th>寬限期</th><th>出貨天數</th><th>剩餘</th></tr>");
                            $.each(result, function(recordIndex, record) {
                                if (record.G_PERIOD_REMAIN == 0) {
                                    $("#dynamicTable").append("<tr class=\"overdue\"><td>" + record.PS_NO + "</td><td>" + record.PS_DD + "</td><td style=\"text-align:right;\">" + numeral(record.AMTN_OUT).format("$0,0") + "</td><td style=\"text-align:right;\">" + record.G_PERIOD + "</td><td style=\"text-align:right;\">" + record.DURATION + "</td><td style=\"text-align:right;\">" + record.G_PERIOD_REMAIN + "</td></tr>");
                                } else {
                                    $("#dynamicTable").append("<tr class=\"pending\"><td>" + record.PS_NO + "</td><td>" + record.PS_DD + "</td><td style=\"text-align:right;\">" + numeral(record.AMTN_OUT).format("$0,0") + "</td><td style=\"text-align:right;\">" + record.G_PERIOD + "</td><td style=\"text-align:right;\">" + record.DURATION + "</td><td style=\"text-align:right;\">" + record.G_PERIOD_REMAIN + "</td></tr>");
                                }
                            });
                            $("tr.overdue").css("color", "red");
                            $("tr.pending,tr.heading").css("color", "black");
                        });
                    } else {
                        $(this).removeClass("selected");
                        $("#dynamicTable").remove();
                    }
                });
            });
        });
    });
</script>